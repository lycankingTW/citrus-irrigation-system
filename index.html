<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>柑橘園智能灌溉計算系統</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      
      .loading-content {
          background: white;
          padding: 2rem;
          border-radius: 10px;
          text-align: center;
      }
      
      .spinner-border {
          width: 3rem;
          height: 3rem;
      }
      
      .result-card {
          border-left: 4px solid #28a745;
          margin-bottom: 1rem;
      }
      
      .recommendation-card {
          margin-bottom: 0.5rem;
      }
      
      .recommendation-critical {
          border-left: 4px solid #dc3545;
      }
      
      .recommendation-warning {
          border-left: 4px solid #ffc107;
      }
      
      .recommendation-info {
          border-left: 4px solid #17a2b8;
      }
      
      .recommendation-success {
          border-left: 4px solid #28a745;
      }
      
      .calculation-step {
          background: #f8f9fa;
          border-left: 3px solid #007bff;
          margin-bottom: 0.5rem;
      }
      
      .hero-section {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 3rem 0;
      }
      
      .form-section {
          background: #f8f9fa;
          padding: 2rem 0;
      }
      
      .results-section {
          padding: 2rem 0;
      }
  </style>
</head>
<body>
  <!-- 載入覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">載入中...</span>
          </div>
          <h5 class="mt-3">正在計算中...</h5>
          <p class="text-muted">請稍候，系統正在進行複雜的水分平衡計算</p>
      </div>
  </div>

  <!-- 標題區 -->
  <div class="hero-section">
      <div class="container">
          <div class="row">
              <div class="col-12 text-center">
                  <h1><i class="fas fa-seedling"></i> 柑橘園智能灌溉計算系統</h1>
                  <p class="lead">基於 FAO-56 蒸發散公式的精準灌溉管理工具</p>
                  <p class="mb-0">開發者：林鈺荏 | 苗栗區農業改良場</p>
              </div>
          </div>
      </div>
  </div>

  <!-- 表單區 -->
  <div class="form-section">
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <div class="card shadow">
                      <div class="card-header bg-primary text-white">
                          <h4 class="mb-0"><i class="fas fa-cogs"></i> 參數設定</h4>
                      </div>
                      <div class="card-body">
                          <form id="irrigationForm">
                              <div class="row">
                                  <!-- 氣象參數 -->
                                  <div class="col-md-6">
                                      <h5 class="text-primary"><i class="fas fa-cloud-sun"></i> 氣象參數</h5>
                                      
                                      <div class="mb-3">
                                          <label for="currentDate" class="form-label">計算日期</label>
                                          <input type="date" class="form-control" id="currentDate">
                                      </div>
                                      
                                      <div class="mb-3">
                                          <label for="temperature" class="form-label">溫度 (°C)</label>
                                          <input type="number" class="form-control" id="temperature" step="0.1" min="-10" max="50" value="25">
                                      </div>

                                      <div class="mb-3">
                                          <label for="humidity" class="form-label">相對濕度 (%)</label>
                                          <input type="number" class="form-control" id="humidity" step="1" min="0" max="100" value="70">
                                      </div>

                                      <div class="mb-3">
                                          <label for="windSpeed" class="form-label">風速 (m/s)</label>
                                          <input type="number" class="form-control" id="windSpeed" step="0.1" min="0" max="20" value="2">
                                      </div>

                                      <div class="mb-3">
                                          <label for="solarRadiation" class="form-label">日照時數 (小時)</label>
                                          <input type="number" class="form-control" id="solarRadiation" step="0.1" min="0" max="24" value="8">
                                      </div>

                                      <div class="mb-3">
                                          <label for="rainfall" class="form-label">降雨量 (mm)</label>
                                          <input type="number" class="form-control" id="rainfall" step="0.1" min="0" value="0">
                                      </div>
                                  </div>

                                  <!-- 作物與土壤參數 -->
                                  <div class="col-md-6">
                                      <h5 class="text-success"><i class="fas fa-seedling"></i> 作物參數</h5>
                                      
                                      <div class="mb-3">
                                          <label for="growthStage" class="form-label">生育期</label>
                                          <select class="form-select" id="growthStage">
                                              <option value="flowerBud">花芽分化期</option>
                                              <option value="flowering">開花期</option>
                                              <option value="fruitSet">結果期</option>
                                              <option value="fruitDevelopment">果實發育期</option>
                                              <option value="maturation">成熟期</option>
                                              <option value="vegetative" selected>營養生長期</option>
                                          </select>
                                      </div>

                                      <div class="mb-3">
                                          <label for="plantAge" class="form-label">樹齡 (年)</label>
                                          <input type="number" class="form-control" id="plantAge" step="1" min="1" max="50" value="5">
                                      </div>

                                      <div class="mb-3">
                                          <label for="plantDensity" class="form-label">種植密度 (株/公頃)</label>
                                          <input type="number" class="form-control" id="plantDensity" step="1" min="50" max="500" value="100">
                                      </div>

                                      <div class="mb-3">
                                          <label for="canopyCover" class="form-label">樹冠覆蓋率 (%)</label>
                                          <input type="number" class="form-control" id="canopyCover" step="1" min="0" max="100" value="70">
                                      </div>

                                      <h5 class="text-warning mt-4"><i class="fas fa-mountain"></i> 土壤參數</h5>
                                      
                                      <div class="mb-3">
                                          <label for="soilType" class="form-label">土壤類型</label>
                                          <select class="form-select" id="soilType">
                                              <option value="sand">砂土</option>
                                              <option value="loamySand">壤砂土</option>
                                              <option value="sandyLoam">砂壤土</option>
                                              <option value="loam" selected>壤土</option>
                                              <option value="clayLoam">黏壤土</option>
                                              <option value="clay">黏土</option>
                                          </select>
                                      </div>

                                      <div class="mb-3">
                                          <label for="currentMoisture" class="form-label">目前土壤含水量 (%)</label>
                                          <input type="number" class="form-control" id="currentMoisture" step="1" min="0" max="100" value="50">
                                      </div>

                                      <div class="mb-3">
                                          <label for="soilDepth" class="form-label">有效土層深度 (cm)</label>
                                          <input type="number" class="form-control" id="soilDepth" step="1" min="20" max="150" value="60">
                                      </div>

                                      <div class="mb-3">
                                          <label for="organicMatter" class="form-label">有機質含量 (%)</label>
                                          <input type="number" class="form-control" id="organicMatter" step="0.1" min="0" max="10" value="2.5">
                                      </div>
                                  </div>
                              </div>

                              <div class="row mt-4">
                                  <!-- 灌溉系統參數 -->
                                  <div class="col-md-6">
                                      <h5 class="text-info"><i class="fas fa-tint"></i> 灌溉系統參數</h5>
                                      
                                      <div class="mb-3">
                                          <label for="irrigationSystem" class="form-label">灌溉系統</label>
                                          <select class="form-select" id="irrigationSystem">
                                              <option value="drip" selected>滴灌系統</option>
                                              <option value="microSprinkler">微噴系統</option>
                                              <option value="sprinkler">噴灌系統</option>
                                              <option value="furrow">溝灌系統</option>
                                          </select>
                                      </div>

                                      <div class="mb-3">
                                          <label for="systemEfficiency" class="form-label">系統效率 (%)</label>
                                          <input type="number" class="form-control" id="systemEfficiency" step="1" min="50" max="95" value="85">
                                      </div>

                                      <div class="mb-3">
                                          <label for="irrigationInterval" class="form-label">灌溉間隔 (天)</label>
                                          <input type="number" class="form-control" id="irrigationInterval" step="1" min="1" max="14" value="3">
                                      </div>

                                      <div class="mb-3">
                                          <label for="mulching" class="form-label">覆蓋材料</label>
                                          <select class="form-select" id="mulching">
                                              <option value="none" selected>無覆蓋</option>
                                              <option value="organic">有機覆蓋</option>
                                              <option value="plastic">塑膠覆蓋</option>
                                              <option value="gravel">碎石覆蓋</option>
                                          </select>
                                      </div>
                                  </div>

                                  <!-- 地理參數 -->
                                  <div class="col-md-6">
                                      <h5 class="text-secondary"><i class="fas fa-map-marker-alt"></i> 地理參數</h5>
                                      
                                      <div class="mb-3">
                                          <label for="latitude" class="form-label">緯度</label>
                                          <input type="number" class="form-control" id="latitude" step="0.1" min="20" max="30" value="24.5">
                                      </div>

                                      <div class="mb-3">
                                          <label for="longitude" class="form-label">經度</label>
                                          <input type="number" class="form-control" id="longitude" step="0.1" min="115" max="125" value="120.8">
                                      </div>

                                      <div class="mb-3">
                                          <label for="elevation" class="form-label">海拔高度 (m)</label>
                                          <input type="number" class="form-control" id="elevation" step="1" min="0" max="3000" value="150">
                                      </div>
                                  </div>
                              </div>

                              <div class="text-center mt-4">
                                  <button type="button" class="btn btn-primary btn-lg" onclick="calculateIrrigation()">
                                      <i class="fas fa-calculator"></i> 開始計算
                                  </button>
                                  <button type="reset" class="btn btn-secondary btn-lg ms-2">
                                      <i class="fas fa-redo"></i> 重設參數
                                  </button>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 結果顯示區 -->
  <div class="results-section">
      <div class="container">
          <div class="row">
              <!-- 計算結果 -->
              <div class="col-md-6">
                  <div class="card shadow">
                      <div class="card-header bg-success text-white">
                          <h4 class="mb-0"><i class="fas fa-chart-line"></i> 計算結果</h4>
                      </div>
                      <div class="card-body" id="resultsDisplay">
                          <p class="text-muted">請輸入參數並點擊計算按鈕</p>
                      </div>
                  </div>
              </div>

              <!-- 管理建議 -->
              <div class="col-md-6">
                  <div class="card shadow">
                      <div class="card-header bg-info text-white">
                          <h4 class="mb-0"><i class="fas fa-lightbulb"></i> 管理建議</h4>
                      </div>
                      <div class="card-body" id="recommendationsDisplay">
                          <p class="text-muted">計算完成後將顯示管理建議</p>
                      </div>
                  </div>
              </div>
          </div>

          <div class="row mt-4">
              <!-- 計算步驟 -->
              <div class="col-md-6">
                  <div class="card shadow">
                      <div class="card-header bg-warning text-dark">
                          <h4 class="mb-0"><i class="fas fa-list-ol"></i> 計算步驟</h4>
                      </div>
                      <div class="card-body" id="calculationStepsDisplay" style="max-height: 400px; overflow-y: auto;">
                          <p class="text-muted">計算步驟將在此顯示</p>
                      </div>
                  </div>
              </div>

              <!-- 水分平衡圖表 -->
              <div class="col-md-6">
                  <div class="card shadow">
                      <div class="card-header bg-dark text-white">
                          <h4 class="mb-0"><i class="fas fa-chart-bar"></i> 水分平衡圖表</h4>
                      </div>
                      <div class="card-body">
                          <canvas id="waterBalanceChart" width="400" height="300"></canvas>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 頁尾 -->
  <footer class="bg-dark text-white text-center py-3 mt-5">
      <div class="container">
          <p class="mb-0">© 2024 苗栗區農業改良場 - 柑橘園智能灌溉計算系統</p>
          <p class="mb-0">開發者：林鈺荏 | 基於 FAO-56 蒸發散公式</p>
      </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- 載入計算器腳本 -->
  <script src="calculator.js"></script>
  
  <!-- UI 更新函數 -->
  <script>
      // 初始化當前日期
      document.addEventListener('DOMContentLoaded', function() {
          const currentDateInput = document.getElementById('currentDate');
          if (currentDateInput) {
              currentDateInput.value = new Date().toISOString().split('T')[0];
          }
      });

      // 更新結果顯示
      function updateResultsDisplay(results) {
          const resultsDiv = document.getElementById('resultsDisplay');
          if (!resultsDiv) return;

          resultsDiv.innerHTML = `
              <div class="result-card card p-3">
                  <h6><i class="fas fa-tint text-primary"></i> 灌溉量建議</h6>
                  <p class="mb-1"><strong>每株灌溉量：</strong> ${results.irrigationAmount.toFixed(1)} 公升</p>
                  <p class="mb-1"><strong>建議灌溉時間：</strong> ${results.irrigationTime.toFixed(0)} 分鐘</p>
                  <p class="mb-0"><strong>下次灌溉：</strong> ${results.nextIrrigation} 天後</p>
              </div>
              
              <div class="result-card card p-3">
                  <h6><i class="fas fa-chart-line text-success"></i> 蒸發散量</h6>
                  <p class="mb-1"><strong>參考蒸發散量 (ET₀)：</strong> ${results.et0.toFixed(2)} mm/day</p>
                  <p class="mb-0"><strong>作物蒸發散量 (ETc)：</strong> ${results.etc.toFixed(2)} mm/day</p>
              </div>
              
              <div class="result-card card p-3">
                  <h6><i class="fas fa-mountain text-warning"></i> 土壤水分狀況</h6>
                  <p class="mb-1"><strong>田間容水量：</strong> ${results.waterBalance.fieldCapacity.toFixed(1)} mm</p>
                  <p class="mb-1"><strong>目前含水量：</strong> ${results.waterBalance.currentWater.toFixed(1)} mm</p>
                  <p class="mb-0"><strong>耗水程度：</strong> ${(results.waterBalance.depletionLevel * 100).toFixed(1)}%</p>
              </div>
          `;
      }

      // 更新建議顯示
      function updateRecommendationsDisplay(recommendations) {
          const recommendationsDiv = document.getElementById('recommendationsDisplay');
          if (!recommendationsDiv || !recommendations) return;

          let html = '';
          recommendations.forEach(rec => {
              html += `
                  <div class="recommendation-card card p-3 recommendation-${rec.type}">
                      <h6><i class="${rec.icon}"></i> ${rec.title}</h6>
                      <p class="mb-0">${rec.message}</p>
                  </div>
              `;
          });

          recommendationsDiv.innerHTML = html || '<p class="text-muted">暫無特殊建議</p>';
      }

      // 更新計算步驟顯示
      function updateCalculationStepsDisplay(steps) {
          const stepsDiv = document.getElementById('calculationStepsDisplay');
          if (!stepsDiv || !steps) return;

          let html = '';
          steps.forEach((step, index) => {
              html += `
                  <div class="calculation-step card p-2 mb-2">
                      <div class="d-flex justify-content-between align-items-start">
                          <div>
                              <h6 class="mb-1">${index + 1}. ${step.title}</h6>
                              <p class="mb-1 small">${step.description}</p>
                              ${step.formula ? `<code class="small">${step.formula}</code>` : ''}
                          </div>
                          <small class="text-muted">${step.timestamp}</small>
                      </div>
                  </div>
              `;
          });

          stepsDiv.innerHTML = html;
      }

      // 更新水分平衡圖表
      function updateWaterBalanceChart(results) {
          const ctx = document.getElementById('waterBalanceChart');
          if (!ctx || !results) return;

          // 銷毀現有圖表
          if (window.waterChart) {
              window.waterChart.destroy();
          }

          const waterBalance = results.waterBalance;
          
          window.waterChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['目前含水量', '可用水量', '不可用水量'],
                  datasets: [{
                      data: [
                          waterBalance.currentWater,
                          waterBalance.availableWater - waterBalance.currentAvailableWater,
                          waterBalance.wiltingPoint
                      ],
                      backgroundColor: [
                          '#28a745',
                          '#ffc107',
                          '#dc3545'
                      ],
                      borderWidth: 2
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: 'bottom'
                      },
                      title: {
                          display: true,
                          text: '土壤水分分布'
                      }
                  }
              }
          });
      }
  </script>
</body>
</html>
